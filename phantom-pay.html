<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Participation Enveloppe Rouge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Courier New', Courier, monospace;
      text-align: center;
      padding: 2rem;
    }
    button {
      margin-top: 2rem;
      padding: 1rem 2rem;
      background-color: crimson;
      color: white;
      font-size: 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üè¥‚Äç‚ò†Ô∏è Embarque pour le tirage de l'Enveloppe Rouge !</h1>
  <p>Envoie <strong>0.1 SOL</strong> au tr√©sor du Kraken.</p>

  <button id="payBtn">Participer avec Phantom</button>

  <p id="status"></p>

  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-base@0.9.11/dist/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-phantom@0.18.10/dist/index.iife.min.js"></script>

  <script>
    (async () => {
      const statusEl = document.getElementById('status');
      const payBtn = document.getElementById('payBtn');
      const { Connection, PublicKey, Transaction, SystemProgram, TransactionInstruction } = solanaWeb3;
      const { PhantomWalletAdapter } = walletAdapterPhantom;

      // R√©cup√©rer tgid depuis l'URL
      const params = new URLSearchParams(window.location.search);
      const tgid = params.get("tgid");
      if (!tgid) {
        statusEl.textContent = "‚ùå Erreur : ID utilisateur manquant dans l'URL (param√®tre tgid).";
        payBtn.disabled = true;
        return;
      }

      // Adresse destinataire
      const recipientPubkey = new PublicKey("AISSEwWcUFx1HfmFi5R6uhQpmoCKyZmibqPG1P3r81Ki");
      const amountSOL = 0.1;
      const lamports = amountSOL * 1e9; // conversion SOL -> lamports

      // Connexion au r√©seau (Mainnet ici, change si besoin)
      const connection = new Connection("https://api.mainnet-beta.solana.com");

      // Setup Phantom wallet adapter
      const wallet = new PhantomWalletAdapter();

      // Connecter automatiquement si Phantom est disponible
      payBtn.addEventListener('click', async () => {
        statusEl.textContent = "‚è≥ Connexion au wallet Phantom...";

        try {
          if (!wallet.connected) {
            await wallet.connect();
          }

          statusEl.textContent = "‚è≥ Pr√©paration de la transaction...";

          // Cr√©ation transaction transfert SOL
          let transaction = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: wallet.publicKey,
              toPubkey: recipientPubkey,
              lamports: lamports,
            }),

            // Memo instruction (optionnel mais utile)
            new TransactionInstruction({
              keys: [],
              programId: new PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),
              data: new TextEncoder().encode(`rouge_${tgid}`),
            })
          );

          transaction.feePayer = wallet.publicKey;

          // R√©cup√©rer le recentBlockhash
          let { blockhash } = await connection.getLatestBlockhash();
          transaction.recentBlockhash = blockhash;

          // Demander signature via Phantom
          statusEl.textContent = "‚è≥ Signature en cours...";
          const signed = await wallet.signTransaction(transaction);

          // Envoyer transaction au r√©seau Solana
          statusEl.textContent = "‚è≥ Envoi de la transaction...";
          const signature = await connection.sendRawTransaction(signed.serialize());

          statusEl.textContent = `‚úÖ Transaction envoy√©e ! Signature : ${signature}`;
        } catch (err) {
          console.error(err);
          statusEl.textContent = "‚ùå Erreur : " + err.message;
        }
      });
    })();
  </script>
</body>
</html>
